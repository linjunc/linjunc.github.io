# 数据链路层

## 功能

数据链路层在物理层提供服务的基础上 `向网络层提供服务`，其最基本的服务是将源自 `网络层` 的数据可靠地传输到相邻节点的 `目标机网络层` 。
其主要作用是**加强物理层传输原始比特流的功能**，将物理层提供的 `可能出错` 的物理连接改造成为逻辑上 `无差错` 的数据链路，使之对网络层表现为一条无差错的链路。

- 功能一：为网络层提供服务。
  - 无确认无连接服务
  - 有确认无连接服务
  - 有确认面向连接服务。（有连接一定有确认）
- 功能二：链路管理，即连接的建立、维持、释放（用于面向连接的服务）
- 功能三：组帧
- 功能四：流量控制（限制发送速度）
- 功能五：差错控制（帧错/位错）

## 封装成帧

封装成帧的目的就是**让数据能够被识别，在数据丢失时，能够溯源**

在实际操作上，封装成帧就是在一段 `数据的前后添加首部和尾部` ，构成帧。接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中 `识别帧的开始和结束`。

因此，首部和尾部一个重要的作用就是：帧定界（由帧定界符控制），当然它还包含了许多的控制信息

帧同步：**接收方**应当能从接收到的二进制比特流中区分出帧的起始和终止

![datalink-1](/img/network/datalink/datalink-1.png)

组帧的四种方法：

1. 字符计数法
2. 字符（节）填充法
3. 零比特填充法
4. 违规编码法

## 透明传输

意思就是不管所传输的数据是什么样的比特组合，**都可以在链路上传输**。链路层看不见有什么东西妨碍了数据的传输，

帧使用首部和尾部进行定界

- 如果帧的 `数据部分` 含有和首部尾部 `相同的内容` ，那么帧的开始和结束位置就会被 `错误的判定` 。需要在数据部分出现首部尾部相同的内容前面 `插入转义字符`。
- 如果数据部分出现转义字符，那么就在转义字符前面再加个转义字符。
- 在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，**用户察觉不到转义字符**的存在。

### 字符填充法

**加头加尾分别标记开始结束**，和零比特填充法（见下）对比，开始和结束的对应的字符不一样

但有**可能出现数据内某段比特流数据正好与标记字段重复**，从而导致误判断的情况

因此会通过添加 `转义字符` ，来标记那些重复的数据，在解析的时候就不会认为这些数据为开始和结束了

![datalink-2-1](/img/network/datalink/datalink-2-1.png)

### 零比特填充法

和字符填充的思路是差不多的，零比特填充首位的标志位都是一样的 `0111110`

因此，在数据流中也有可能存在相同的字符，这里会采用补 0 的方式，来解决这个冲突的问题

- 在发送端，会扫描整个信息字段，只要连续 5 个 1，就会填入 1 个 0
- 在接收端，会对比特流进行扫描，发现 5 个连续的 1 时，就会删除后面的 0

![datalink-2-2](/img/network/datalink/datalink-2-2.png)

## 差错控制（检错编码）

传输中的差错都是由噪声引起的。可以通过 `提高信噪比` 来减少或者避免干扰。

### 1. 奇偶校验码

操作方法就是：发送的时候通过添加一位附加比特来形成奇数码

奇偶校验码特点：只能检查出奇数个比特错误，检错能力为 50%

因为，一段数据中，一个从 0 --> 1 ，一个从 1 --> 0 ，0，1 的数量是不变的，无法检测出错误。只能检测出 1，3，5 等这些奇位数错误

![datalink-3](/img/network/datalink/datalink-3.png)

### 2. 循环冗余码 CRC

- 循环冗余检验 CRC
  - 目前数据链路层广泛使用了 `循环冗余检验`（CRC）来检查比特差错。
- 帧检验序列 FCS
  - `在数据后面添加上的冗余码` 称为帧检验序列 FCS (Frame Check Sequence)。
- 概要: CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码。
  - FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的唯一方法。

如果数据链路层接收了这个帧，说明这个帧没有差错

这种也不是可靠传输，因为有一些帧会被丢弃掉，并不是发送什么就接受什么

## 差错控制（纠错编码）

### 海明码

1. 首先需要确认检验码的位数
   - 满足 2 的 r 次方 大于等于 k + r + 1
2. 确定校验码和数据的位置
   - 检验码放在 2 的次方的位置，1，2，4，8...
   - 数据依次添满
3. 求出校验码的值
    - 通过二进制位确定有几位
    - 然后看检验码的二进制位的数值和所有信息位的**对应位置**的数值是否相同，然后找出来这些位
      - 例如第一个检验码 0001，那么和他一起的信息码就是第一位为 1 的，例如 0011,0111,这些都是
    - 接着把这些数异或一下，就是这些检验码的值
4. 检错并纠错
   - 按照检错的位数，通过异或来得到出错的是第几位

## 流量控制与可靠传输机制

较高的发送速度和较低的接收能力不匹配，会造成传输出错，因此需要进行流量的控制

传输层和数据链路层都会进行流量控制，两者有一定的区别

- 数据链路层的流量控制是**点对点**的
- 接收方收不下就不回复确认（确认帧），这样就不会继续发送下一个

- 传输层的流量控制是**端到端**的
- 接收端给发送端发送一个窗口公告

**可靠传输**：发送端发啥，接收端收啥

**流量控制**：控制发送速率，使接收方有足够的缓冲空间来接收每一个帧

## 停止等待协议

停止等待协议存在的意义：除了比特出差错，底层信道还会出现丢包的问题

有两种不同的应用情况

- 无差错情况
- 有差错情况

### 1. 无差错情况

一次只发送一个帧，可以用 0、1 标记 ack

发送方收到了确认就可以继续发送下一帧

> 虽然是 0、1 ，但是每一帧都是不一样的内容

### 2. 有差错情况

在发送数据的时候，会设置一个定时器，当超过时间后，没有收到对方的 ACK 确认应答报文后，会重发这个数据，也就是超时重传

定时器设定的时间也很有讲究，需要大于 RTT

> RTT 指的是数据发送时刻到接收到确认的时刻的差值，也就是包的往返时间。

有可能因为这两种情况发送超时重传

- 数据包丢失
- ACK 丢失
- ACK 迟到
  - 来晚了不会处理，会直接丢弃

**`缺点`**：停止等待协议的信道利用率比较低

## GBN 协议

连续发送，提高信道利用率

![datalink-4-1](/img/network/datalink/datalink-4-1.png)

- 这样每一帧的序号都需要是不一样的，接收端才能返回唯一对应的帧
- 发送方需要缓存多个分组，因为有可能会帧丢失，所以需要重发，需要先缓存下来

累计确认：就是收到一个确认帧，那么它和它**之前的所有帧**都默认已收到，反之，如果某个确认帧没收到，那么它和它之后的所有帧都**默认丢失**（即使收到了也丢掉），进行重传

### 发送方做的事情

![datalink-4-2](/img/network/datalink/datalink-4-2.png)

### 接收方做的事

如果正确收到 n 号帧，并且**按序**，那么接收方为 n 帧**发送一个 ACK**，并将该帧中的数据部分交付给上层

其余情况都丢弃帧，并为最近按序接收的帧重新发送 ACK。接收方无需缓存任何失序帧，只需要维护一个信息：`expectedseqnum`（下一个按序接收的帧序号）

### GBN 重点

1. 累积确认
2. 接收方只按顺序接收帧，不按序的会被丢弃
3. 确认序列号最大的，按序到达的帧
4. 发送窗口最大为 2^n - 1 接收窗口为 1

### GBN 协议性能分析

因连续发送数据帧而**提高了信道利用率**

在重传时必须把**原来已经正确传送的数据帧重传**，使传送效率降低

## 滑动窗口

滑动窗口的大小决定了发送方连续发送帧的数量，不需要等待 ACK 可以继续发送，但是此时窗口不会移动，只是发窗口里的帧，由于数据中帧有可能会重复

例如： 01230123

那么如果窗口过长，窗口大小大于了 4 时，无法确定接收到的 ACK 0 为第一次的确认帧，还是第二次的确认帧，因此滑动窗口的大小应当限制在 2 ^ n - 1 内

## SR 协议

### 发送方要做的事

1. 收到数据后，检查下一个可用于该帧的序号，如果位于发送窗口，发送数据帧
2. 收到 ACK 时，如果是窗口的下届，窗口移动，否则继续等
3. 超时事件，超时重传

### 接收方做的事

SR 接收方，不管是否按序都会接收。如果不是按序的话，会先缓存起来，把这些都排好序，等到最小的那个帧被收到了，这时候就可以交付这些帧，窗口移动

每接收到一个帧都会发送一个 ACK

### 滑动窗口长度

发送窗口大小等于接收窗口，2 的 （n - 1) 次方

### 重点

1. 逐一确认
2. 只重传出错的帧
3. 接收方会缓存非按序的帧

## 信道复用技术

### 频分复用、时分复用和统计时分复用

- 频分复用 FDM
  - 用户在分配到一定的频带后，在通信过程中**自始至终都占用这个频带。**
- 时分复用 TDM
  - 时分复用则是将时间划分为一段段等长的时分复用帧。每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时隙。
- 统计时分复用 STDM
  - 是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送。

### 波分复用

- 波分复用 WDM
  - 光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波。

### 码分复用

- 码分复用 CDM
  - 常用的名词是码分多址 CDMA
  - 各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。
  - 这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现。
  - 每一个比特时间划分为 m 个短的间隔，称为码片。

## 纯 ALOHA 协议
**思想**：不监听信道，不按时间槽发送，随机发送，想法就发

**冲突解决**：发送方在一定时间内收不到确认就判断为发生冲突，会等一个**随机时间**进行重传

## 时隙 ALOHA 协议
和纯 ALOHA 相比，限制了发送的时间，有点类似于 Fiber，就只能在规定的时间片发送数据

- 纯 ALOHA 比时隙 ALOHA **吞吐量更低，效率更低**
- 纯 ALOHA 想发就发，时隙 ALOHA 只有在**时间片段开始时**才能发