<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小丞前端日记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/orange.png">
    <meta name="description" content="小丞同学的博客，致力于分享高质量的 React,JS 相关博文">
    
    <link rel="preload" href="/assets/css/0.styles.0cb4b130.css" as="style"><link rel="preload" href="/assets/js/app.a050530d.js" as="script"><link rel="preload" href="/assets/js/2.9ca92e07.js" as="script"><link rel="preload" href="/assets/js/3.334401cf.js" as="script"><link rel="prefetch" href="/assets/js/10.6e958c0c.js"><link rel="prefetch" href="/assets/js/11.95969b7c.js"><link rel="prefetch" href="/assets/js/12.4c68fcb9.js"><link rel="prefetch" href="/assets/js/13.b6894616.js"><link rel="prefetch" href="/assets/js/14.514c46cc.js"><link rel="prefetch" href="/assets/js/15.213684b6.js"><link rel="prefetch" href="/assets/js/16.3ec938ae.js"><link rel="prefetch" href="/assets/js/17.b676430d.js"><link rel="prefetch" href="/assets/js/18.9494a132.js"><link rel="prefetch" href="/assets/js/19.e1195932.js"><link rel="prefetch" href="/assets/js/20.6cf61f06.js"><link rel="prefetch" href="/assets/js/21.ee003277.js"><link rel="prefetch" href="/assets/js/22.2966ebdd.js"><link rel="prefetch" href="/assets/js/23.b956afce.js"><link rel="prefetch" href="/assets/js/24.b330257c.js"><link rel="prefetch" href="/assets/js/25.77b6aa14.js"><link rel="prefetch" href="/assets/js/26.e18839bd.js"><link rel="prefetch" href="/assets/js/27.9e901bf5.js"><link rel="prefetch" href="/assets/js/28.5de074c9.js"><link rel="prefetch" href="/assets/js/29.153f13ef.js"><link rel="prefetch" href="/assets/js/30.17e368e3.js"><link rel="prefetch" href="/assets/js/31.34cda385.js"><link rel="prefetch" href="/assets/js/32.1e0f1e54.js"><link rel="prefetch" href="/assets/js/33.cf778f7a.js"><link rel="prefetch" href="/assets/js/34.ab8f668a.js"><link rel="prefetch" href="/assets/js/35.3221c626.js"><link rel="prefetch" href="/assets/js/36.0efd720d.js"><link rel="prefetch" href="/assets/js/37.4a116a1f.js"><link rel="prefetch" href="/assets/js/38.e6a60214.js"><link rel="prefetch" href="/assets/js/39.2a30a1bf.js"><link rel="prefetch" href="/assets/js/4.2007bec8.js"><link rel="prefetch" href="/assets/js/40.08c54456.js"><link rel="prefetch" href="/assets/js/41.cfee696d.js"><link rel="prefetch" href="/assets/js/42.125c5466.js"><link rel="prefetch" href="/assets/js/43.91a3cfe5.js"><link rel="prefetch" href="/assets/js/44.5428d32b.js"><link rel="prefetch" href="/assets/js/45.4f4528b1.js"><link rel="prefetch" href="/assets/js/46.6138ce94.js"><link rel="prefetch" href="/assets/js/47.aaebf4b6.js"><link rel="prefetch" href="/assets/js/48.078e43e3.js"><link rel="prefetch" href="/assets/js/49.0a44f322.js"><link rel="prefetch" href="/assets/js/5.85f6b89d.js"><link rel="prefetch" href="/assets/js/50.159e339a.js"><link rel="prefetch" href="/assets/js/51.336f0e09.js"><link rel="prefetch" href="/assets/js/52.42ebda8c.js"><link rel="prefetch" href="/assets/js/53.8e00c210.js"><link rel="prefetch" href="/assets/js/54.4b0b5a0f.js"><link rel="prefetch" href="/assets/js/55.84b2fe5b.js"><link rel="prefetch" href="/assets/js/56.97062723.js"><link rel="prefetch" href="/assets/js/57.9055d09d.js"><link rel="prefetch" href="/assets/js/58.ace2216e.js"><link rel="prefetch" href="/assets/js/59.cfa34bfc.js"><link rel="prefetch" href="/assets/js/6.6e57d4a5.js"><link rel="prefetch" href="/assets/js/60.7b717444.js"><link rel="prefetch" href="/assets/js/61.61dbd9bc.js"><link rel="prefetch" href="/assets/js/62.28ff7373.js"><link rel="prefetch" href="/assets/js/63.cf07df7d.js"><link rel="prefetch" href="/assets/js/64.bd10ee7c.js"><link rel="prefetch" href="/assets/js/65.79a0b0f0.js"><link rel="prefetch" href="/assets/js/66.9f41c408.js"><link rel="prefetch" href="/assets/js/67.3ac14554.js"><link rel="prefetch" href="/assets/js/68.9cb1dee2.js"><link rel="prefetch" href="/assets/js/69.880cbf28.js"><link rel="prefetch" href="/assets/js/7.51410411.js"><link rel="prefetch" href="/assets/js/70.3d1c5ecc.js"><link rel="prefetch" href="/assets/js/71.d6138285.js"><link rel="prefetch" href="/assets/js/72.137b17ba.js"><link rel="prefetch" href="/assets/js/73.d6d94315.js"><link rel="prefetch" href="/assets/js/74.5e1b585c.js"><link rel="prefetch" href="/assets/js/75.c76a0b8c.js"><link rel="prefetch" href="/assets/js/76.550ca9f6.js"><link rel="prefetch" href="/assets/js/77.b95cc65d.js"><link rel="prefetch" href="/assets/js/78.585346b6.js"><link rel="prefetch" href="/assets/js/79.7a4027c9.js"><link rel="prefetch" href="/assets/js/8.87341fa7.js"><link rel="prefetch" href="/assets/js/80.cabf1199.js"><link rel="prefetch" href="/assets/js/81.f2d1dbce.js"><link rel="prefetch" href="/assets/js/82.06d96b08.js"><link rel="prefetch" href="/assets/js/83.6bced6da.js"><link rel="prefetch" href="/assets/js/9.d43ff011.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0cb4b130.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/orange.png" alt="小丞前端日记" class="logo"> <span class="site-name can-hide">小丞前端日记</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="各类知识点" class="dropdown-title"><span class="title">各类知识点</span> <span class="arrow down"></span></button> <button type="button" aria-label="各类知识点" class="mobile-dropdown-title"><span class="title">各类知识点</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/summary/qrcode.html" class="nav-link">
  前端总结
</a></li><li class="dropdown-item"><!----> <a href="/pages/structure/start.html" class="nav-link">
  数据结构和算法
</a></li><li class="dropdown-item"><!----> <a href="/pages/css/layout/flex.html" class="nav-link">
  CSS 布局方式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端面试合集" class="dropdown-title"><span class="title">前端面试合集</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端面试合集" class="mobile-dropdown-title"><span class="title">前端面试合集</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/interview/heading/best1.html" class="nav-link">
  面试题精选
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React 全家桶" class="dropdown-title"><span class="title">React 全家桶</span> <span class="arrow down"></span></button> <button type="button" aria-label="React 全家桶" class="mobile-dropdown-title"><span class="title">React 全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/react/primary/jsx.html" class="nav-link">
  React 入门
</a></li><li class="dropdown-item"><!----> <a href="/pages/react/hard/fiberidea.html" class="nav-link">
  React 源码解析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于我" class="dropdown-title"><span class="title">关于我</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于我" class="mobile-dropdown-title"><span class="title">关于我</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/about/about.html" class="nav-link">
  关于我
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/linjunc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/1460594842018446" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/m0_50855872" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="各类知识点" class="dropdown-title"><span class="title">各类知识点</span> <span class="arrow down"></span></button> <button type="button" aria-label="各类知识点" class="mobile-dropdown-title"><span class="title">各类知识点</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/summary/qrcode.html" class="nav-link">
  前端总结
</a></li><li class="dropdown-item"><!----> <a href="/pages/structure/start.html" class="nav-link">
  数据结构和算法
</a></li><li class="dropdown-item"><!----> <a href="/pages/css/layout/flex.html" class="nav-link">
  CSS 布局方式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端面试合集" class="dropdown-title"><span class="title">前端面试合集</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端面试合集" class="mobile-dropdown-title"><span class="title">前端面试合集</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/interview/heading/best1.html" class="nav-link">
  面试题精选
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React 全家桶" class="dropdown-title"><span class="title">React 全家桶</span> <span class="arrow down"></span></button> <button type="button" aria-label="React 全家桶" class="mobile-dropdown-title"><span class="title">React 全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/react/primary/jsx.html" class="nav-link">
  React 入门
</a></li><li class="dropdown-item"><!----> <a href="/pages/react/hard/fiberidea.html" class="nav-link">
  React 源码解析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="关于我" class="dropdown-title"><span class="title">关于我</span> <span class="arrow down"></span></button> <button type="button" aria-label="关于我" class="mobile-dropdown-title"><span class="title">关于我</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/about/about.html" class="nav-link">
  关于我
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/linjunc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/1460594842018446" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/m0_50855872" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React 源码解析</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/react/hard/start.html" class="sidebar-link">专栏介绍</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React 哲学</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/react/hard/fiberidea.html" class="sidebar-link">React 设计理念</a></li><li><a href="/pages/react/hard/constructure.html" aria-current="page" class="active sidebar-link">React Fiber 架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#fiber-架构的起源" class="sidebar-link">Fiber 架构的起源</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#认识-fiber" class="sidebar-link">认识 Fiber</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#fiber-的作用" class="sidebar-link">Fiber 的作用</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#fiber-的含义" class="sidebar-link">Fiber 的含义</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#fiber-的结构" class="sidebar-link">Fiber 的结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#静态数据结构的属性" class="sidebar-link">静态数据结构的属性</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#用来形成-fiber-树的属性" class="sidebar-link">用来形成 Fiber 树的属性</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#作为动态的工作单元的属性" class="sidebar-link">作为动态的工作单元的属性</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#优先级相关的属性" class="sidebar-link">优先级相关的属性</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#其他" class="sidebar-link">其他</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#fiber-的更新机制" class="sidebar-link">Fiber 的更新机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#双缓存机制" class="sidebar-link">双缓存机制</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#双缓存-fiber-树" class="sidebar-link">双缓存 Fiber 树</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#mount-时" class="sidebar-link">mount 时</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#update-时" class="sidebar-link">update 时</a></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#整体更新流程" class="sidebar-link">整体更新流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/react/hard/constructure.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Render 阶段</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Commit 阶段</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Diff 算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>状态更新</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Scheduler 模块</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hooks 实现</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>事件系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Context 状态原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React 全家桶</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>在 React 16 版本中采用了<strong>新的 Reconciler</strong> 来实现 异步可中断的更新， Reconciler 内部采用了全新的 Fiber 架构来实现。这节来谈谈 Fiber 架构</p> <h2 id="fiber-架构的起源"><a href="#fiber-架构的起源" class="header-anchor">#</a> Fiber 架构的起源</h2> <p>在 React15 及以前，Reconciler 采用<strong>递归</strong>的方式创建虚拟 DOM，递归过程是<strong>不能中断</strong>的。如果组件树的<strong>层级很深</strong>，递归会占用线程很多时间，造成卡顿，因为浏览器所有的时间都交给了 js 执行，并且 js 的执行时单线程的，导致无法在一帧内执行完毕。同时 React 15 采用了调用堆栈的方式，造成了调用栈过深难以执行等问题<br><img src="/assets/img/1.6791bf48.png" alt="image.png"><br>为了解决这些问题，React 16 就引入了<strong>Scheduler调度器</strong>进行时间片的调度，给每个 task 工作单元分配一定的时间，如果在这个时间内任务没有执行完，也要交出执行权给浏览器进行回流和重绘，因此实现异步可中断的更新需要一定的数据结构在内存中保存工作单元的信息，曾经的虚拟 DOM 数据结构已经无法满足需要，于是有了新的数据结构，也就是 Fiber <br><strong>React Fiber 的目标是提高它在动画、布局和手势等领域的适用性。最重要的功能就是增量渲染：能够将渲染工作分成块，并将其分散到多个帧上</strong><br>其他关键功能有以下</p> <ul><li>在新更新到来时<strong>暂停、中止或重用工作的能力</strong></li> <li>能够为不同类型的更新分配优先级</li> <li>新的并发原语</li></ul> <p><strong>React Fiber 是调用堆栈的重新实现，专门用于 React 组件，也就是一种 虚拟堆栈帧，这样的优点是将堆栈帧保存在内存中，并随行所欲的执行他们。</strong><br><img src="/assets/img/2.ff69355e.png" alt="image.png"></p> <h2 id="认识-fiber"><a href="#认识-fiber" class="header-anchor">#</a> 认识 Fiber</h2> <p>首先需要弄清楚 React.element 、Fiber 和 真实 DOM 节点三者间的关系<br><img src="/assets/img/3.3eefaf69.png" alt="image.png"></p> <ul><li>element 是 React 视图层在代码的表象，也就是我们写的 JSX ，这些都会被创建成 element 对象的形式，上面保存了 props、children 等信息</li> <li>DOM 就很纯粹了就是浏览器真实渲染的</li> <li>Fiber 可以说是 elmenet 和真实 DOM 的桥梁，每一个类型的 element 都会有一个对应类型的 Fiber，element 变化引起更新流程都是通过 Fiber 做一次调和改变，然后通知渲染器形成新的 DOM 渲染</li></ul> <p>在 Fiber 结构中 element 和 Fiber 之间的对应关系</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> FunctionComponent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">// 对应函数组件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ClassComponent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">// 对应的类组件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IndeterminateComponent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 初始化时不知道是函数组件还是类组件 </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostRoot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                <span class="token comment">// Root Fiber 可以理解为跟元素</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostPortal <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>              <span class="token comment">// 对应  ReactDOM.createPortal 产生的 Portal </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostComponent <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>           <span class="token comment">// dom 元素 比如 &lt;div&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostText <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>                <span class="token comment">// 文本节点</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Fragment <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>                <span class="token comment">// 对应 &lt;React.Fragment&gt; </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Mode <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>                    <span class="token comment">// 对应 &lt;React.StrictMode&gt;   </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextConsumer <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>         <span class="token comment">// 对应 &lt;Context.Consumer&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextProvider <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token comment">// 对应 &lt;Context.Provider&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ForwardRef <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>             <span class="token comment">// 对应 React.ForwardRef</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Profiler <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>               <span class="token comment">// 对应 &lt;Profiler/ &gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseComponent <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>      <span class="token comment">// 对应 &lt;Suspense&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> MemoComponent <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>          <span class="token comment">// 对应 React.memo 返回的组件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="fiber-的作用"><a href="#fiber-的作用" class="header-anchor">#</a> Fiber 的作用</h2> <p>那么有了 Fiber 这种数据结构后，能完成哪些事情呢，</p> <ul><li><strong>工作单元 任务分解</strong> ：Fiber 最重要的功能就是<strong>作为工作单元</strong>，保存原生节点或者组件节点对应信息（包括优先级），这些节点通过<strong>链表</strong>的形似形成 Fiber 树</li> <li><strong>增量渲染</strong>：通过 jsx 对象和 <code>current Fiber</code> 的对比，生成最小的差异补丁，应用到真实节点上</li> <li><strong>根据优先级暂停、继续、排列优先级</strong>：Fiber 节点上保存了<strong>优先级</strong>，能通过不同节点优先级的对比，达到任务的暂停、继续、排列优先级等能力，也为上层实现批量更新、Suspense 提供了基础</li> <li><strong>保存状态</strong>：因为 Fiber 能保存状态和更新的信息，所以就能<strong>实现函数组件的状态更新</strong>，也就是 hooks</li></ul> <h2 id="fiber-的含义"><a href="#fiber-的含义" class="header-anchor">#</a> Fiber 的含义</h2> <ol><li>作为架构来说，React15 的 Reconciler 采用递归的方式进行，<strong>数据保存在调用堆栈中</strong>，因此也叫做 <code>stack Reconciler</code>，React16 的 Reconciler 基于 Fiber 节点实现，被称为 <code>Fiber Reconciler</code></li> <li>作为静态数据结构来说，每个 Fiber 节点对应一个 React Element，保存该组件的相关信息</li> <li>作为动态的工作单元，每个 Fiber 节点保存了本次更新中该组件改变的状态，要执行的工作（effectList）</li></ol> <h2 id="fiber-的结构"><a href="#fiber-的结构" class="header-anchor">#</a> Fiber 的结构</h2> <p>Fiber 是一个 JS 对象，Fiber 的创建是根据 React 元素来创建的，在整个 React 构建的虚拟 DOM 树中，每一个元素都有对应的 Fiber，从而构建一个 Fiber 树，每个 Fiber 不仅仅包含每个元素的信息，还包含更多的信息，以方便 Scheduler 来进行调度<br>我们分成几个部分来看</p> <h3 id="静态数据结构的属性"><a href="#静态数据结构的属性" class="header-anchor">#</a> 静态数据结构的属性</h3> <p><strong>作为一种静态的数据结构，保存了组件相关的信息：</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token comment">// 作为静态数据结构的属性</span>
  <span class="token comment">// 标记不同的组件类型</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> WorkTag<span class="token punctuation">,</span>
  <span class="token comment">// ReactElement 里面的key</span>
  <span class="token comment">// 唯一标识，如果出现列表的时候，需要为每一个 item 指定 key</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>
  <span class="token comment">// ReactElement.type，createElement 的第一个参数</span>
  <span class="token literal-property property">elementType</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token comment">// 异步组件resolved之后返回的内容，一般是 function 或者 class</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token comment">// 当前组件实例的引用,比如浏览器环境就是DOM节点</span>
  <span class="token literal-property property">stateNode</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token operator">|</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="用来形成-fiber-树的属性"><a href="#用来形成-fiber-树的属性" class="header-anchor">#</a> 用来形成 Fiber 树的属性</h3> <p>作为架构来说，这些属性用来形成 Fiber Tree</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token comment">// 指向他在 Fiber 节点树中的 parent，用来在处理完这个节点之后向上返回</span>
  <span class="token keyword">return</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// 指向自己的第一个子节点</span>
  <span class="token literal-property property">child</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// 指向自己的兄弟结构</span>
  <span class="token literal-property property">sibling</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">index</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token operator">|</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>我们知道了 <code>Fiber</code> 可以保存真实的 DOM ，真实的 DOM 对应在内存中的 Fiber 节点会形成 Fiber 树<br>Fiber 树通过 return、child、slibing 指针形成，连接父子兄弟节点以构成一颗单链表 fiber 树，其扁平化的单链表结构的特点将以往递归遍历改为了<strong>循环遍历</strong>，实现深度优先遍历。<br><img src="/assets/img/4.0861dd89.png" alt="image.png"><br>同时，这颗由真实DOM 构建成的 Fiber 树也就是 <code>current Fiber Tree</code>，而正在构建的 Fiber 树叫做 <code>WIP Fiber</code>，这两颗树的节点通过 <code>alternate</code> 指针相连，这也是 Fiber 架构的双缓存机制，下面会讲到<br><img src="/assets/img/5.c7388a9c.png" alt="image.png"></p> <h3 id="作为动态的工作单元的属性"><a href="#作为动态的工作单元的属性" class="header-anchor">#</a> 作为动态的工作单元的属性</h3> <p><strong>作为动态的工作单元，Fiber中如下参数保存了本次更新相关的信息，</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token comment">// 新的变动带来的新的props</span>
  <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span> 
  <span class="token comment">// 上一次渲染完成之后的props</span>
  <span class="token literal-property property">memoizedProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// 该 Fiber 对应的组件产生的 Update 会存放在这个队列里面</span>
  <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// 上一次渲染的时候的 state</span>
  <span class="token comment">// 用来存放某个组件内所有的 Hook 状态</span>
  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// 一个列表，存放这个 Fiber 依赖的 context</span>
  <span class="token literal-property property">firstContextDependency</span><span class="token operator">:</span> ContextDependency<span class="token operator">&lt;</span>mixed<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">//用来描述fiber是处于何种模式。用二进制位来表示</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> TypeOfMode<span class="token punctuation">,</span>

  <span class="token literal-property property">flags</span><span class="token operator">:</span> Flags<span class="token punctuation">,</span><span class="token comment">// fiber 节点包含的副作用标识</span>
  <span class="token literal-property property">subtreeFlags</span><span class="token operator">:</span> Flags<span class="token punctuation">,</span><span class="token comment">// 子树包含的副作用标识，避免深度遍历</span>
  <span class="token literal-property property">deletions</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Fiber<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">// 删除的节点，用于执行 unmount 钩子</span>

  <span class="token comment">// 用来记录Side Effect具体的执行的工作的类型：比如Placement，Update等等</span>
  <span class="token literal-property property">effectTag</span><span class="token operator">:</span> SideEffectTag<span class="token punctuation">,</span>

  <span class="token comment">// 单链表用来快速查找下一个 side effect</span>
  <span class="token literal-property property">nextEffect</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// 子树中第一个side effect</span>
  <span class="token literal-property property">firstEffect</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// 子树中最后一个side effect</span>
  <span class="token literal-property property">lastEffect</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token operator">...</span>
<span class="token operator">|</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="优先级相关的属性"><a href="#优先级相关的属性" class="header-anchor">#</a> 优先级相关的属性</h3> <p>保存调度的优先级相关的信息</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token comment">// 调度优先级相关</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>childLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token operator">|</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>React 原先采用的是 <code>expiration</code>的概念，在后来被 <code>lane</code> 模型取代了</p> <h3 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ref指向，ref函数，或者ref对象。</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">//current和workInProgress的指针</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="fiber-的更新机制"><a href="#fiber-的更新机制" class="header-anchor">#</a> Fiber 的更新机制</h2> <p>我们以及知道了 Fiber 有哪些属性，以及 Fiber 之间是如何建立关联的，那么接下来就要看看 Fiber 是如何工作的</p> <h3 id="双缓存机制"><a href="#双缓存机制" class="header-anchor">#</a> 双缓存机制</h3> <p>当我们使用 <code>canvas</code> 绘制动画时，如果上一帧计算量比较大，导致清除上一帧画面到绘制当前帧画面之间有较长间隙，就会出现白屏。<br>为了解决这个问题，<code>canvas</code> <strong>在内存中绘制当前动画，绘制完毕后直接用当前帧替换上一帧画面</strong>，由于省去了两帧替换间的计算时间，不会出现从白屏到出现画面的闪烁情况。<br>这种<strong>在内存中构建并直接替换</strong>的技术叫做<strong>双缓存</strong>。</p> <h3 id="双缓存-fiber-树"><a href="#双缓存-fiber-树" class="header-anchor">#</a> 双缓存 Fiber 树</h3> <p>React 也践行了这一理念，在 React 中最多会同时存在两颗 Fiber 树。当前真正显示的一颗 Fiber 树，也叫做 current Fiber Tree，正在内存中构建的 Fiber 树称为 workInProgress Fiber 树<br>current Fiber 和 workInProgress Fiber 通过 alternate 指针相互连接</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> workInProgressFiber<span class="token punctuation">;</span>
workInProgressFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> currentFiber<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在下一次渲染时，React 会直接复用 workInProgress Fiber 树作为下一次的渲染树，上一次的渲染树又作为缓存树，这样不仅防止只有一棵树容易状态丢失的问题，又加快了 DOM 节点的更新和替换</p> <h3 id="mount-时"><a href="#mount-时" class="header-anchor">#</a> mount 时</h3> <h4 id="第一步-创建-fiberroot-和-rootfiber"><a href="#第一步-创建-fiberroot-和-rootfiber" class="header-anchor">#</a> 第一步：创建 FiberRoot 和 RootFiber</h4> <p>首次执行 <code>ReactDOM.render</code> 会创建 <code>fiberRoot</code> 和 <code>rootFiber</code>，<strong>其中 <code>fiberRoot</code></strong> 是整个应用的根节点，<strong><code>rootFiber</code></strong> 是组件树的根节点，一个 React 应用可以有多个 <code>rootFiber</code>，但是只能有一个 <code>fiberRoot</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Index<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>第一次挂载时，会将 <code>fiberRoot</code> 和 <code>rootFiber</code> 建立起关联，也就是 current 指针</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token parameter">containerInfo<span class="token punctuation">,</span>tag</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* 创建一个root */</span>
    <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span>tag<span class="token punctuation">)</span>
    <span class="token keyword">const</span> rootFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> rootFiber
    <span class="token keyword">return</span> root
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAbkAAAEACAIAAACh85/CAAABQmlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSCwoyGFhYGDIzSspCnJ3UoiIjFJgf8bAyiDKwM2gwsCWmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsgsB9Wwziq3CAaGXuVa/9TfyZjqUQBXSmoxSM0fIE5JLigqYWBgTACylctLCkDsFiBbpAjoKCB7BoidDmGvAbGTIOwDYDUhQc5A9hUgWyA5IzEFyH4CZOskIYmnI7Gh9oLdEODho2BkbupqSMCxpIKS1IoSEO2cX1BZlJmeUaLgCAyhVAXPvGQ9HQUjAyMjBgZQeENUf74BDkdGMQ6EWFoMA4PxJgYGpmSEWNZFBob9GkAvOCDEVFcyMPCqMTAc6CxILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y5jYGC+BdT7DQBfv1wlJG5KWwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAABIAAAAAQAAAEgAAAABAAKgAgAEAAAAAQAAAbmgAwAEAAAAAQAAAQAAAAAA9hEqBAAAAAlwSFlzAAALEwAACxMBAJqcGAAAIjZJREFUeAHtnXuAVtPex/cz03TRRUknSiWkOJJOpVT0ek+Kigq9covcColyOeJ4iVMIub6OHLdyKlHoIio5IkmJ41JyKpRCrt1075n3+7SbNWt69nPZ0/PM7OeZz/5j5ves9dtr/dZn7fnOWnvtZ20nv+BYt25dgZn498qVKxM7FXj4Kjl9zsRc0CGR33C2aXBt2DS4Nmwa5trIcTggAAEIQCARAbQyESHyIQABCDgOWslVAAEIQCAxAbQyMSM8IAABCKCVXAMQgAAEEhNAKxMzwgMCEIAAWsk1AAEIQCAxAbQyMSM8IAABCKCVXAMQgAAEEhMI6Rn9xF5RHuvXr99///2jkgOdQMwl0z1whnMsAhl9bZQzkuerGTjbVwM0oGETsG2ujayhwRzc7kpsCEAAAt4E0EpvLqRCAAIQsAmglTYNbAhAAALeBNBKby6kQgACELAJoJU2DWwIQAAC3gTQSm8upEIAAhCwCaCVNg1sCEAAAt4E0EpvLqRCAAIQsAmglTYNbAhAAALeBNBKby6kQgACELAJoJU2DWwIQAAC3gTKeSeTWhoE9KbNCRMmzJo1a/ny5b/++mtphECdxSFQs2bNI444omXLlpdeemleXl5xiuCcwBNAK4PSRRLKU0899bvvvgtKQMSRNIFfdh8ffPDBq6++Om3atHLl+LNKml3mOLInW1D6aty4cY8//niFChUGDRp04okn1qtXLyiREUciAt9///3bb88ZOfKBbdu2aWjZt2/fRGekIN/XDkYpqC8VRWR2zBrOuIc2siwwE/9euXJlYqcCD18lp8854DFffvnlxxxzjBSzABu/M4zAP//5T/Vgz5497bjL7PVsQzB2wP8GTZy2YWJmbScV/y5TUcayZctUTIcOHVJRGGWUAgHNBlSrxpilUDdVpp8AWpl+xsnV8PPPP8uxTp06ybnjFTgC9evXV0ybNm0KXGQElAoCaGUqKFIGBCCQ7QTQymzvYdoHAQikggBamQqKlAEBCGQ7AbQy23uY9kEAAqkggFamgiJlQAAC2U4Arcz2HqZ9EIBAKgiglamgSBkQgEC2E0Ars72HaR8EIJAKAmhlKihSBgQgkO0E0Mps72GrfUuXLt28ebOVUOZMbePEdxDLXK+nqMFoZYpABqmYf/zjH506dWratOnLL79s4gqHw7169frkk09MSrGNoUOHqnBztGjR4vTTT1elO3fuLHaZ7om7du3617/+ZQqZPn26annttddMims8++yz3bp12ysxmY8PP/zwo48+mownPhDYi0A57ZJkkmzbJMYycLbJpI+GXUsy9tq1ayUH999/f7Nmzfbff/9kTimGj/Txrrvuck/UN9nfe++9p59+Wl+F1oZyxSjNnDJnzpwhQ4ZoI0iTIuPuu+9u06aN9tO1E4Ns73Ux7PUxfuQ423wCRaOc+XNSWMa2w/W0cbaxpI+GXUuStkaOlSpV0rgySf/iue23335mh00ZzZs31+ZjU6ZM2UetjA6mfPnyEv2//e1vDz74YHRuMFPsv6P0XRuUbPd+CdBgA2cbeGbbs2fPHjNmzG+//bZ169aLLrrINEbbdGvQZz7K1vbdW7ZsadeunQZxFStWdLN++uknjeA++ugj7TesYePNN99crVo1ZQ0fPvyoo47SLrbPP/+8fs6cOdMUZRtHH3301KlTtfFfKBRS+vz58//+979/+eWXtWvXPuWUU6666qqc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" alt="image.png"><br>因为是首屏渲染，页面中还没有挂载任何的 DOM，所以 <code>fiberRoot.current</code> 指向的 rootFiber 没有任何的 子 Fiber 节点</p> <h4 id="第二步-workinprogress-和-current"><a href="#第二步-workinprogress-和-current" class="header-anchor">#</a> 第二步：workInProgress 和 current</h4> <p>接下来进入了 <code>render</code> 阶段，会进入 <code>beginWork</code> 的流程，会根据组件返回的 JSX 在内存中依次创建 Fiber 节点，并连接在一起构建形成 Fiber 树，被称为 <code>workInProgress Fiber</code> 树</p> <blockquote><ul><li>workInProgress：正在内存中构建的 Fiber 树称为 <code>workInProgress Fiber</code>树。在一次更新中，所有的更新都是发生在 workInProgress 树上。在一次更新之后，workInProgress 树上的状态是最新的状态，那么它将变成 current 树用于渲染视图。</li> <li>current：正在视图层渲染的树叫做 current 树。</li></ul></blockquote> <p>在构建 WIP Fiber 树的时候会尝试复用 current Fiber 树，中已有的 Fiber 节点内的属性，也就是 alternate。在首屏渲染中初始化的 rootFiber 是没有 alternate 的，那么会创建一个 Fiber 作为 WIP，会用 alternate 指针将 WIP 和 current 树建立关联</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgressFiber
workInProgressFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentFiber
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="第三步-深度调和子节点-渲染视图"><a href="#第三步-深度调和子节点-渲染视图" class="header-anchor">#</a> <img src="/assets/img/7.07c7b243.png" alt="image.png"><br>第三步：深度调和子节点，渲染视图</h4> <p>接下来会按照上一步的方法，在 WIP 下完成整个 Fiber 的遍历及创建，生成一颗完整的 WIP Tree<br>最后会以 workInProgress 作为最新的渲染树，<strong>fiberRoot 的 current 指针指向 workInProgress 使其变为 current Fiber 树。到此完成初始化流程。</strong><br><img src="/assets/img/8.1943b7cf.png" alt="image.png"></p> <h3 id="update-时"><a href="#update-时" class="header-anchor">#</a> update 时</h3> <p>接着上面的结构，当我们点击一次按钮触发更新时，首先会创建一颗 <code>workInProgress</code> 树，复用当前 <code>current</code> 树上的 <code>alternate</code> ，作为新的 WIP，由于初始化 <code>rootFiber</code> 有 <code>alternate</code> ，所以对于剩余的子节点，React 还需要创建一份，和 <code>current</code> 树上的 <code>Fiber</code> 建立起 <code>alternate</code>关联。渲染完毕后，<code>workInProgress</code> 再次变成 <code>current</code> 树<br><img src="/assets/img/9.8b0f8df9.png" alt="image.png"></p> <h3 id="整体更新流程"><a href="#整体更新流程" class="header-anchor">#</a> 整体更新流程</h3> <ol><li>初始化渲染，根据 React Element 生成对应的 Fiber 树</li> <li>进行 setState 等操作，触发更新</li> <li>创建 workInProgress 副本，进入 Reconciliation 执行对应的 render 更新。</li> <li>记录有副作用的 fiber 节点，放入一个队列</li> <li>完成 Reconciliation，进入 Commit 阶段，取出有副作用的 fiber 节点，通过 fiber 节点的 nextEffect 属性访问有副作用的节点，进行更新</li></ol> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="https://react.iamkasong.com/process/doubleBuffer.html#update%E6%97%B6" target="_blank" rel="noopener noreferrer">React 技术揭秘<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> -- Fiber 架构的工作原理</li> <li><a href="https://www.youtube.com/watch?v=ZCuYPiUIONs&amp;t=801s" target="_blank" rel="noopener noreferrer">React Conf 2017<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> -- 关于 Fiber 架构</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">lastUpdate:</span> <span class="time">7/20/2022, 2:14:02 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/react/hard/fiberidea.html" class="prev">
        React 设计理念
      </a></span> <span class="next"><a href="/pages/react/hard/beginwork.html">
        Render 阶段 -- Beginwork
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a050530d.js" defer></script><script src="/assets/js/2.9ca92e07.js" defer></script><script src="/assets/js/3.334401cf.js" defer></script>
  </body>
</html>
